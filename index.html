<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>559 Warren Street #5D ‚Äî Sell or Rent Analysis</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=JetBrains+Mono:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700;800;900&display=swap');

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #F7EEDB;
    --primary: #1C5355;
    --primary-light: #1C535515;
    --accent: #4EB8BC;
    --accent-light: #4EB8BC15;
    --card: #FFFFFF;
    --red: #D94F4F;
    --red-light: #D94F4F12;
    --orange: #E8A838;
    --purple: #7C6BBF;
    --green: #5B9E5B;
    --text: #1a1a1a;
    --muted: #888;
    --border: #000;
    --shadow: 4px 4px 0 0 #000;
    --shadow-sm: 2px 2px 0 0 #000;
    --shadow-lg: 6px 6px 0 0 #000;
    --mono: 'JetBrains Mono', 'Courier New', monospace;
    --sans: 'DM Sans', -apple-system, sans-serif;
    --serif: 'DM Serif Display', Georgia, serif;
  }

  html { scroll-behavior: smooth; }
  body { font-family: var(--sans); background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }
  
  .mono { font-family: var(--mono); }
  .serif { font-family: var(--serif); }

  .card {
    background: var(--card);
    border: 2px solid var(--border);
    box-shadow: var(--shadow);
    padding: 24px;
    opacity: 0;
    transform: translateY(16px);
    animation: cardIn 0.5s ease forwards;
  }
  @keyframes cardIn { to { opacity: 1; transform: translateY(0); } }
  .card:nth-child(2) { animation-delay: 0.05s; }
  .card:nth-child(3) { animation-delay: 0.1s; }
  .card:nth-child(4) { animation-delay: 0.15s; }

  .badge {
    display: inline-block;
    padding: 4px 12px;
    border: 2px solid currentColor;
    font-weight: 800;
    font-size: 11px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-family: var(--mono);
  }
  .badge-primary { color: var(--primary); background: var(--primary-light); }
  .badge-accent { color: var(--accent); background: var(--accent-light); }
  .badge-orange { color: var(--orange); background: #E8A83822; }
  .badge-red { color: var(--red); background: var(--red-light); }

  .grid { display: grid; gap: 20px; }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
  .stack { display: flex; flex-direction: column; gap: 20px; }

  .stat-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin-bottom: 2px;
  }
  .stat-value {
    font-family: var(--mono);
    font-weight: 800;
    font-size: 26px;
  }
  .stat-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .stat-center { text-align: center; padding: 16px; }

  table { width: 100%; border-collapse: collapse; font-family: var(--mono); font-size: 13px; }
  table th {
    text-align: left;
    padding: 10px 12px;
    font-weight: 800;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid #000;
  }
  table td { padding: 9px 12px; border-bottom: 1px solid #eee; }
  table .total-row td { border-top: 3px solid #000; border-bottom: none; font-weight: 900; }

  .btn {
    background: var(--primary);
    color: var(--bg);
    border: 2px solid var(--border);
    box-shadow: var(--shadow);
    padding: 14px 36px;
    font-size: 15px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 2px;
    cursor: pointer;
    font-family: var(--sans);
    transition: transform 0.1s, box-shadow 0.1s;
  }
  .btn:active { transform: translate(2px, 2px); box-shadow: var(--shadow-sm); }
  .btn-ghost {
    background: none;
    border: none;
    box-shadow: none;
    color: var(--muted);
    padding: 0;
    font-weight: 700;
    cursor: pointer;
    font-family: var(--sans);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .btn-reset {
    background: var(--bg);
    border: 2px solid #000;
    padding: 8px 16px;
    font-weight: 700;
    font-size: 12px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: var(--sans);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .alert-box {
    padding: 20px 24px;
    border: 2px solid;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .alert-box.green { background: var(--primary-light); border-color: var(--primary); box-shadow: 4px 4px 0 0 var(--primary); }
  .alert-box.red { background: var(--red-light); border-color: var(--red); box-shadow: 4px 4px 0 0 var(--red); }
  .alert-title { font-weight: 800; font-size: 14px; margin-bottom: 6px; }
  .alert-body { font-size: 14px; line-height: 1.6; }

  .callout-big {
    background: var(--primary);
    border: 2px solid #000;
    box-shadow: var(--shadow-lg);
    padding: 28px 32px;
    color: var(--bg);
  }
  .callout-big .label { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; opacity: 0.7; margin-bottom: 4px; }
  .callout-big .headline { font-size: 24px; font-weight: 900; margin-bottom: 12px; font-family: var(--serif); }
  .callout-big .body { font-size: 14px; line-height: 1.6; opacity: 0.9; }

  .tabs { display: flex; border-bottom: 2px solid #000; overflow-x: auto; margin-bottom: 20px; }
  .tab-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 12px 18px;
    background: transparent;
    color: #666;
    border: none;
    border-bottom: 2px solid transparent;
    font-weight: 800;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
    font-family: var(--sans);
  }
  .tab-btn.active { background: var(--primary); color: var(--bg); border-bottom-color: var(--primary); }

  .pros-item, .cons-item {
    font-size: 13px;
    padding: 6px 0;
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }
  .pros-item::before { content: '+'; font-weight: 800; color: var(--primary); }
  .cons-item::before { content: '‚àí'; font-weight: 800; color: var(--red); }

  .step-row { display: flex; gap: 12px; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #eee; }
  .step-row:last-child { border-bottom: none; }
  .step-num {
    width: 28px; height: 28px; border-radius: 50%; background: var(--primary); color: var(--bg);
    display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px;
    font-family: var(--mono); flex-shrink: 0;
  }

  .slider-wrap { margin-bottom: 12px; }
  .slider-head { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
  .slider-head .label { font-weight: 600; }
  .slider-head .val { font-family: var(--mono); font-weight: 700; color: var(--primary); }
  input[type="range"] { width: 100%; accent-color: var(--primary); }

  .num-input-wrap { margin-bottom: 12px; }
  .num-input-wrap label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .num-input-box { display: flex; align-items: center; border: 2px solid #000; background: #fff; }
  .num-input-prefix { padding: 8px 0 8px 12px; font-weight: 700; color: var(--primary); font-family: var(--mono); }
  .num-input-box input {
    flex: 1; padding: 8px 12px; border: none; outline: none; background: transparent;
    font-family: var(--mono); font-weight: 700; font-size: 14px;
  }

  .select-wrap { margin-bottom: 12px; }
  .select-wrap label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .select-wrap select {
    width: 100%; padding: 8px 12px; border: 2px solid #000; background: #fff;
    font-family: var(--mono); font-weight: 700; font-size: 13px; cursor: pointer;
  }

  .settings-toggle {
    width: 100%; display: flex; align-items: center; justify-content: space-between;
    background: none; border: none; cursor: pointer; padding: 16px 20px; font-family: var(--sans);
  }
  .settings-body { padding: 0 20px 20px; border-top: 2px solid #eee; }

  .chart-bar-wrap { position: relative; height: 30px; margin-bottom: 8px; border-radius: 2px; overflow: hidden; }
  .chart-bar-fill { height: 100%; transition: width 0.6s ease; border-radius: 2px; }
  .chart-bar-label {
    position: absolute; left: 8px; top: 50%; transform: translateY(-50%);
    font-family: var(--mono); font-size: 11px; font-weight: 700; color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  svg.mini-chart { display: block; }

  .winner-cell { font-weight: 700; }
  .winner-a { background: var(--primary-light); color: var(--primary); }
  .winner-b { background: var(--accent-light); color: var(--primary); }
  .loser { color: var(--muted); }

  .collapsible-btn {
    width: 100%; display: flex; align-items: center; justify-content: space-between;
    background: none; border: none; cursor: pointer; padding: 0;
    font-weight: 800; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;
    font-family: var(--sans); color: var(--text);
  }

  .hidden { display: none; }

  /* Landing */
  .landing { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; }
  .landing-tag { display: inline-block; border: 2px solid #000; box-shadow: var(--shadow); padding: 6px 16px; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 24px; background: #fff; }
  .landing h1 { font-size: clamp(36px, 6vw, 56px); font-weight: 900; line-height: 1.1; margin-bottom: 16px; font-family: var(--serif); color: var(--primary); }
  .landing h2 { font-size: clamp(18px, 3vw, 24px); font-weight: 400; line-height: 1.4; margin-bottom: 32px; color: #666; }
  .landing-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 40px; max-width: 550px; width: 100%; }
  .landing-stat { background: #fff; border: 2px solid #000; box-shadow: var(--shadow); padding: 20px; }
  .landing-stat .val { font-family: var(--mono); font-size: 28px; font-weight: 900; color: var(--primary); }
  .landing-stat .lbl { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-top: 4px; }
  .landing-footer { margin-top: 24px; font-size: 12px; color: #aaa; font-family: var(--mono); }
  @media (max-width: 520px) { .landing-stats { grid-template-columns: 1fr; } }

  /* Analysis wrapper */
  .analysis { padding: 20px; max-width: 1100px; margin: 0 auto; }
  .analysis-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
  .analysis-title { font-size: 24px; font-weight: 900; font-family: var(--serif); color: var(--primary); margin: 0; }
  .analysis-subtitle { margin: 2px 0 0; font-size: 13px; color: var(--muted); }
  .analysis-footer { text-align: center; margin-top: 40px; padding: 20px 0; border-top: 2px solid #eee; font-size: 12px; color: #aaa; font-family: var(--mono); }

  /* Donut */
  .donut-wrap { display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; }
  .donut-legend { display: flex; flex-direction: column; gap: 6px; }
  .donut-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; font-family: var(--mono); }
  .donut-legend-swatch { width: 14px; height: 14px; border: 1px solid #000; flex-shrink: 0; }

  /* Print styles */
  @media print {
    body { background: #fff; }
    .card { box-shadow: none; break-inside: avoid; page-break-inside: avoid; border: 1px solid #ccc; opacity: 1; transform: none; animation: none; }
    .btn, .btn-ghost, .btn-reset, .tabs, .settings-toggle, #settings-body, .slider-wrap input[type="range"] { display: none !important; }
    .callout-big { break-inside: avoid; }
    .alert-box { box-shadow: none; }
    .analysis { padding: 10px; }
    .hidden { display: none !important; }
  }
</style>
</head>
<body>

<div id="app-landing" class="landing">
  <div style="max-width: 700px;">
    <div class="landing-tag">559 Warren Street ¬∑ Brooklyn</div>
    <h1>Sell or Rent?</h1>
    <h2>A comprehensive scenario analysis for your real estate decision.</h2>
    <div class="landing-stats">
      <div class="landing-stat"><div class="val">$575K</div><div class="lbl">Est. Value</div></div>
      <div class="landing-stat"><div class="val">2.5%</div><div class="lbl">Mortgage Rate</div></div>
      <div class="landing-stat"><div class="val">$285K+</div><div class="lbl">Equity Built</div></div>
    </div>
    <button class="btn" onclick="showAnalysis()">View Full Analysis ‚Üí</button>
    <div class="landing-footer">Built by Iconoclastic Capital Management</div>
  </div>
</div>

<div id="app-analysis" class="analysis hidden">
  <div class="analysis-header">
    <div>
      <button class="btn-ghost" onclick="showLanding()">‚Üê Back</button>
      <h1 class="analysis-title">559 Warren Street #5D</h1>
      <p class="analysis-subtitle">The Warren Building ¬∑ Brooklyn, NY</p>
    </div>
    <span class="badge badge-primary">SCENARIO ANALYSIS</span>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="card" style="margin-bottom: 20px; padding: 0;">
    <button class="settings-toggle" onclick="toggleSettings()">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 16px;">‚öô</span>
        <span style="font-weight: 800; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Analysis Settings</span>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <span id="settings-summary" class="mono" style="font-size: 12px; color: var(--muted);"></span>
        <span id="settings-chevron">‚ñº</span>
      </div>
    </button>
    <div id="settings-body" class="settings-body hidden">
      <div class="grid grid-3" style="padding-top: 16px;">
        <div class="num-input-wrap">
          <label>Estimated Sale Price</label>
          <div class="num-input-box"><span class="num-input-prefix">$</span><input type="number" id="in-salePrice" step="5000" oninput="onInputChange()"></div>
        </div>
        <div class="num-input-wrap">
          <label>New Home Purchase Price</label>
          <div class="num-input-box"><span class="num-input-prefix">$</span><input type="number" id="in-newHomePrice" step="10000" oninput="onInputChange()"></div>
        </div>
        <div class="num-input-wrap">
          <label>Available Liquid Savings ‚Äî TOD Account (Option B)</label>
          <div class="num-input-box"><span class="num-input-prefix">$</span><input type="number" id="in-liquidSavings" step="5000" oninput="onInputChange()"></div>
        </div>
        <div class="slider-wrap">
          <div class="slider-head"><span class="label">Annual Appreciation Rate</span><span class="val" id="lbl-appreciation"></span></div>
          <input type="range" id="in-appreciation" min="0" max="8" step="0.5" oninput="onInputChange()">
        </div>
        <div class="select-wrap">
          <label>Filing Status</label>
          <select id="in-filingStatus" onchange="onInputChange()">
            <option value="single">Single</option>
            <option value="mfj">Married Filing Jointly</option>
          </select>
        </div>
        <div class="num-input-wrap">
          <label>Years Lived as Primary Residence</label>
          <div class="num-input-box"><input type="number" id="in-yearsResidence" step="1" oninput="onInputChange()"></div>
        </div>
        <div class="num-input-wrap">
          <label>Capital Improvements Made</label>
          <div class="num-input-box"><span class="num-input-prefix">$</span><input type="number" id="in-capImprovements" step="1000" oninput="onInputChange()"></div>
        </div>
        <div class="slider-wrap">
          <div class="slider-head"><span class="label">Broker Commission Rate</span><span class="val" id="lbl-commission"></span></div>
          <input type="range" id="in-commission" min="4" max="6" step="0.25" oninput="onInputChange()">
        </div>
        <div class="select-wrap">
          <label>Federal CGT Bracket</label>
          <select id="in-federalCGT" onchange="onInputChange()">
            <option value="0">0% (income under $94K)</option>
            <option value="0.15">15% (income $94K‚Äì$583K)</option>
            <option value="0.20">20% (income over $583K)</option>
          </select>
        </div>
        <div class="select-wrap">
          <label>Income Tax Bracket (depreciation)</label>
          <select id="in-incomeBracket" onchange="onInputChange()">
            <option value="0.22">22%</option>
            <option value="0.24">24%</option>
            <option value="0.32">32%</option>
            <option value="0.37">37%</option>
          </select>
        </div>
        <div class="num-input-wrap">
          <label>Years Held as Rental (if kept)</label>
          <div class="num-input-box"><input type="number" id="in-yearsRental" step="1" oninput="onInputChange()"></div>
        </div>
      </div>
      <div style="text-align: right; margin-top: 12px;">
        <button class="btn-reset" onclick="resetDefaults()">‚Ü∫ Reset to Defaults</button>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs" id="tab-nav"></div>

  <!-- TAB CONTENT -->
  <div id="tab-content"></div>

  <div class="analysis-footer">ICONOCLASTIC CAPITAL MANAGEMENT ¬∑ FEE-ONLY FIDUCIARY ¬∑ BUILT WITH CLAUDE</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROPERTY = {
  address: "559 Warren Street #5D", building: "The Warren Building", city: "Brooklyn, NY",
  bedrooms: 2, bathrooms: 1, sqft: 1100, purchaseDate: "January 2019", purchasePrice: 565000,
  currentBalance: 289350, mortgageRate: 2.5, monthlyPI: 2237, monthlyHOA: 1807,
  monthlyTaxes: 605, monthlyInsurance: 0, originalLoan: 452000
};
const COMPS = [
  { unit: "559 Warren #4E", price: 515000, date: "Aug 2024" },
  { unit: "559 Warren #6B", price: 550000, date: "Jun 2024" },
  { unit: "561 Warren #3A", price: 560000, date: "Aug 2024" }
];
const COLORS = ["#1C5355", "#4EB8BC", "#E8A838", "#D94F4F", "#7C6BBF", "#5B9E5B"];

const DEFAULTS = {
  estimatedSalePrice: 575000, newHomePurchasePrice: 900000, liquidSavings: 300000,
  appreciationRate: 3, filingStatus: "mfj", yearsInResidence: 6, capitalImprovements: 0,
  brokerCommissionRate: 5, federalCGTRate: 0.15, incomeTaxBracket: 0.24, yearsHeldAsRental: 5,
  monthlyRent: 5500, vacancyPercent: 5, maintenancePercent: 10, propertyManagementPercent: 0,
  newMortgageRate: 6.5, downPaymentPercent: 20
};

let S = { ...DEFAULTS };
let activeTab = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORMATTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fmt = n => {
  if (n == null || isNaN(n)) return "$0";
  const neg = n < 0; const a = Math.abs(n);
  return (neg ? "-" : "") + "$" + Math.round(a).toLocaleString("en-US");
};
const fmtK = n => {
  if (Math.abs(n) >= 1e6) return "$" + (n / 1e6).toFixed(1) + "M";
  if (Math.abs(n) >= 1000) return "$" + Math.round(n / 1000) + "K";
  return fmt(n);
};
const pctF = (n, d = 1) => n.toFixed(d) + "%";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALCULATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcSell() {
  const sale = S.estimatedSalePrice;
  const nycRate = sale >= 500000 ? 0.01425 : 0.011;
  const nycTax = sale * nycRate;
  const nysTax = sale * 0.004;
  const broker = sale * (S.brokerCommissionRate / 100);
  const attorney = 3000, mortSat = 500, misc = sale * 0.001;
  const totalCC = nycTax + nysTax + broker + attorney + mortSat + misc;
  const net = sale - totalCC - PROPERTY.currentBalance;

  const adjBasis = PROPERTY.purchasePrice + S.capitalImprovements;
  const grossGain = sale - adjBasis - totalCC;
  const excl = S.filingStatus === "mfj" ? 500000 : 250000;
  const q121 = S.yearsInResidence >= 2;
  const taxable = q121 ? Math.max(0, grossGain - excl) : Math.max(0, grossGain);
  const fedTax = taxable * S.federalCGTRate;
  const nysTaxCG = taxable * 0.0685;
  const nycTaxCG = taxable * 0.03876;
  const totalTax = fedTax + nysTaxCG + nycTaxCG;

  return {
    cc: { nycTax, nycRate, nysTax, broker, brokerPct: S.brokerCommissionRate, attorney, mortSat, misc, total: totalCC },
    cg: { adjBasis, grossGain, sellingCosts: totalCC, excl, taxable, fedRate: S.federalCGTRate, fedTax, nysRate: 0.0685, nysTaxCG, nycRate: 0.03876, nycTaxCG, totalTax, exempt: taxable === 0, q121 },
    net
  };
}

function calcRental() {
  const r = S.monthlyRent;
  const egi = r * (1 - S.vacancyPercent / 100);
  const maint = r * (S.maintenancePercent / 100);
  const mgmt = r * (S.propertyManagementPercent / 100);
  const totalExp = PROPERTY.monthlyPI + PROPERTY.monthlyHOA + PROPERTY.monthlyTaxes + PROPERTY.monthlyInsurance + maint + mgmt;
  const cf = egi - totalExp;
  const annCF = cf * 12;
  const equity = S.estimatedSalePrice - PROPERTY.currentBalance;
  const roe = equity > 0 ? (annCF / equity) * 100 : 0;
  const bldg = S.estimatedSalePrice * 0.8;
  const annDepr = bldg / 27.5;
  const annSavings = annDepr * S.incomeTaxBracket;
  const totalDepr = annDepr * S.yearsHeldAsRental;
  const recap = totalDepr * 0.25;

  return { egi, maint, mgmt, totalExp, cf, annCF, roe, bldg, annDepr, annSavings, totalDepr, recap };
}

function calcEquity(annCF) {
  const yrs = [];
  let pv = S.estimatedSalePrice, bal = PROPERTY.currentBalance;
  const mr = PROPERTY.mortgageRate / 100 / 12;
  let cumCF = 0;
  for (let y = 0; y <= S.yearsHeldAsRental; y++) {
    yrs.push({ year: y, pv: Math.round(pv), bal: Math.round(bal), eq: Math.round(pv - bal), cumCF: Math.round(cumCF), combined: Math.round(pv - bal + cumCF) });
    for (let m = 0; m < 12; m++) { const int = bal * mr; bal = Math.max(0, bal - (PROPERTY.monthlyPI - int)); }
    pv *= (1 + S.appreciationRate / 100);
    cumCF += annCF;
  }
  return yrs;
}

function calcMortPayment(principal, rateAnn, years = 30) {
  const r = rateAnn / 100 / 12, n = years * 12;
  if (r === 0) return principal / n;
  return principal * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
}

function calcBuyerCC(price, loan) {
  const mrtRate = loan >= 500000 ? 0.0205 : 0.018;
  const mrt = loan * mrtRate;
  let manRate = 0;
  if (price >= 5e6) manRate = 0.02;
  else if (price >= 3e6) manRate = 0.015;
  else if (price >= 2e6) manRate = 0.0125;
  else if (price >= 1e6) manRate = 0.01;
  const man = price * manRate;
  const title = price * 0.005, att = 3000, insp = 2000;
  const total = mrt + man + title + att + insp;
  return { mrt, mrtRate, man, manRate, title, att, insp, total, effPct: (total / price) * 100 };
}

function calcBuying(sellNet) {
  const np = S.newHomePurchasePrice, dpPct = S.downPaymentPercent / 100;
  const calc = (dp) => {
    const loan = np - dp;
    const cc = calcBuyerCC(np, Math.max(0, loan));
    const netDP = dp - cc.total;
    const actLoan = np - Math.max(0, netDP);
    const pi = calcMortPayment(Math.max(0, actLoan), S.newMortgageRate);
    const tax = (np * 0.012) / 12, ins = 200;
    const max = netDP > 0 ? netDP / dpPct : 0;
    return { dp, cc, netDP, loan: actLoan, pi, tax, ins, piti: pi + tax + ins, max };
  };
  return { a: calc(sellNet), b: calc(S.liquidSavings) };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIMPLE SVG CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function horizBarChart(data, width = 500, height = 36) {
  // data = [{label, value, color}]
  const max = Math.max(...data.map(d => Math.abs(d.value)), 1);
  let html = '';
  data.forEach(d => {
    const w = (Math.abs(d.value) / max) * 100;
    html += `<div style="margin-bottom: 10px;">
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px;">
        <span style="font-weight:700;">${d.label}</span>
        <span class="mono" style="font-weight:700;">${fmt(d.value)}</span>
      </div>
      <div style="height:${height}px;background:#eee;border:1px solid #ddd;border-radius:2px;overflow:hidden;">
        <div style="width:${w}%;height:100%;background:${d.color};border-radius:2px;transition:width 0.5s ease;"></div>
      </div>
    </div>`;
  });
  return html;
}

function donutChart(data, size = 160) {
  // data = [{label, value, color}]
  const total = data.reduce((s, d) => s + d.value, 0);
  const r = size / 2 - 8, ir = r * 0.55, cx = size / 2, cy = size / 2;
  let angle = -Math.PI / 2;
  let paths = '';
  data.forEach(d => {
    const pct = d.value / total;
    const a1 = angle;
    const a2 = angle + pct * 2 * Math.PI;
    const large = pct > 0.5 ? 1 : 0;
    const x1o = cx + r * Math.cos(a1), y1o = cy + r * Math.sin(a1);
    const x2o = cx + r * Math.cos(a2), y2o = cy + r * Math.sin(a2);
    const x1i = cx + ir * Math.cos(a2), y1i = cy + ir * Math.sin(a2);
    const x2i = cx + ir * Math.cos(a1), y2i = cy + ir * Math.sin(a1);
    paths += `<path d="M${x1o},${y1o} A${r},${r} 0 ${large} 1 ${x2o},${y2o} L${x1i},${y1i} A${ir},${ir} 0 ${large} 0 ${x2i},${y2i} Z" fill="${d.color}" stroke="#fff" stroke-width="2"/>`;
    angle = a2;
  });
  let legend = data.map(d => `<div class="donut-legend-item"><div class="donut-legend-swatch" style="background:${d.color}"></div><span>${d.label}: ${fmt(d.value)}</span></div>`).join('');
  return `<div class="donut-wrap">
    <svg class="mini-chart" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">${paths}
      <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central" font-family="var(--mono)" font-size="12" font-weight="800" fill="#1C5355">${fmt(total)}</text>
    </svg>
    <div class="donut-legend">${legend}</div>
  </div>`;
}

function areaChart(data, width = 600, height = 250) {
  // data = [{year, eq, cumCF}]
  const maxY = Math.max(...data.map(d => Math.max(d.eq, d.cumCF)), 1);
  const minY = Math.min(0, ...data.map(d => Math.min(d.eq, d.cumCF)));
  const range = maxY - minY || 1;
  const pad = { t: 20, r: 20, b: 60, l: 65 };
  const cw = width - pad.l - pad.r, ch = height - pad.t - pad.b;
  const x = (i) => pad.l + (i / Math.max(data.length - 1, 1)) * cw;
  const y = (v) => pad.t + (1 - (v - minY) / range) * ch;

  let gridLines = '';
  const ticks = 5;
  for (let i = 0; i <= ticks; i++) {
    const v = minY + (range / ticks) * i;
    const yy = y(v);
    gridLines += `<line x1="${pad.l}" y1="${yy}" x2="${width - pad.r}" y2="${yy}" stroke="#ddd" stroke-dasharray="3,3"/>`;
    gridLines += `<text x="${pad.l - 8}" y="${yy + 4}" text-anchor="end" font-family="var(--mono)" font-size="10" fill="#888">${fmtK(v)}</text>`;
  }
  data.forEach((d, i) => {
    gridLines += `<text x="${x(i)}" y="${height - 35}" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="#888">Yr ${d.year}</text>`;
  });

  const makePath = (key, color) => {
    let pts = data.map((d, i) => `${x(i)},${y(d[key])}`).join(' ');
    let area = `M${x(0)},${y(0)} L` + pts + ` L${x(data.length - 1)},${y(0)} Z`;
    return `<polygon points="" fill="none"/><path d="${area}" fill="${color}20" stroke="none"/><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="2.5"/>` +
      data.map((d, i) => `<circle cx="${x(i)}" cy="${y(d[key])}" r="4" fill="${color}" stroke="#fff" stroke-width="2"/>`).join('');
  };

  return `<svg class="mini-chart" width="100%" height="${height}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
    ${gridLines}
    ${makePath('cumCF', '#4EB8BC')}
    ${makePath('eq', '#1C5355')}
    <rect x="${pad.l}" y="${height - 18}" width="12" height="12" fill="#1C5355" rx="2"/><text x="${pad.l + 16}" y="${height - 8}" font-family="var(--mono)" font-size="10" fill="#666">Property Equity</text>
    <rect x="${pad.l + 140}" y="${height - 18}" width="12" height="12" fill="#4EB8BC" rx="2"/><text x="${pad.l + 156}" y="${height - 8}" font-family="var(--mono)" font-size="10" fill="#666">Cumulative Cash Flow</text>
  </svg>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLanding() { window.location.hash = ''; document.getElementById('app-landing').classList.remove('hidden'); document.getElementById('app-analysis').classList.add('hidden'); }
function showAnalysis() { window.location.hash = 'analysis'; document.getElementById('app-landing').classList.add('hidden'); document.getElementById('app-analysis').classList.remove('hidden'); window.scrollTo(0, 0); render(); }
function toggleSettings() {
  const b = document.getElementById('settings-body');
  const c = document.getElementById('settings-chevron');
  b.classList.toggle('hidden');
  c.textContent = b.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function syncInputsToState() {
  document.getElementById('in-salePrice').value = S.estimatedSalePrice;
  document.getElementById('in-newHomePrice').value = S.newHomePurchasePrice;
  document.getElementById('in-liquidSavings').value = S.liquidSavings;
  document.getElementById('in-appreciation').value = S.appreciationRate;
  document.getElementById('in-filingStatus').value = S.filingStatus;
  document.getElementById('in-yearsResidence').value = S.yearsInResidence;
  document.getElementById('in-capImprovements').value = S.capitalImprovements;
  document.getElementById('in-commission').value = S.brokerCommissionRate;
  document.getElementById('in-federalCGT').value = S.federalCGTRate;
  document.getElementById('in-incomeBracket').value = S.incomeTaxBracket;
  document.getElementById('in-yearsRental').value = S.yearsHeldAsRental;
  document.getElementById('lbl-appreciation').textContent = S.appreciationRate + '%';
  document.getElementById('lbl-commission').textContent = S.brokerCommissionRate + '%';
}

function readInputs() {
  S.estimatedSalePrice = parseFloat(document.getElementById('in-salePrice').value) || 0;
  S.newHomePurchasePrice = parseFloat(document.getElementById('in-newHomePrice').value) || 0;
  S.liquidSavings = parseFloat(document.getElementById('in-liquidSavings').value) || 0;
  S.appreciationRate = parseFloat(document.getElementById('in-appreciation').value) || 0;
  S.filingStatus = document.getElementById('in-filingStatus').value;
  S.yearsInResidence = parseFloat(document.getElementById('in-yearsResidence').value) || 0;
  S.capitalImprovements = parseFloat(document.getElementById('in-capImprovements').value) || 0;
  S.brokerCommissionRate = parseFloat(document.getElementById('in-commission').value) || 5;
  S.federalCGTRate = parseFloat(document.getElementById('in-federalCGT').value) || 0;
  S.incomeTaxBracket = parseFloat(document.getElementById('in-incomeBracket').value) || 0.24;
  S.yearsHeldAsRental = parseFloat(document.getElementById('in-yearsRental').value) || 5;
  document.getElementById('lbl-appreciation').textContent = S.appreciationRate + '%';
  document.getElementById('lbl-commission').textContent = S.brokerCommissionRate + '%';
}

function onInputChange() { readInputs(); render(); }
function resetDefaults() { S = { ...DEFAULTS }; syncInputsToState(); render(); }

// Read rental/buying sliders from dynamic content
function readRentalSliders() {
  const el = (id) => document.getElementById(id);
  if (el('in-rent')) S.monthlyRent = parseFloat(el('in-rent').value) || 5500;
  if (el('in-vacancy')) S.vacancyPercent = parseFloat(el('in-vacancy').value) || 5;
  if (el('in-maint')) S.maintenancePercent = parseFloat(el('in-maint').value) || 10;
  if (el('in-mgmt')) S.propertyManagementPercent = parseFloat(el('in-mgmt').value) || 0;
}
function readBuyingSliders() {
  const el = (id) => document.getElementById(id);
  if (el('in-newRate')) S.newMortgageRate = parseFloat(el('in-newRate').value) || 6.5;
  if (el('in-dpPct')) S.downPaymentPercent = parseFloat(el('in-dpPct').value) || 20;
}
function onRentalChange() { readRentalSliders(); render(); }
function onBuyingChange() { readBuyingSliders(); render(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TAB_NAMES = ["Overview", "Option A: Sell", "Option B: Rent", "Buying Power", "The Verdict"];
const TAB_ICONS = ["üè†", "üí∞", "üîë", "üìà", "‚öñÔ∏è"];

function renderTabs() {
  document.getElementById('tab-nav').innerHTML = TAB_NAMES.map((name, i) =>
    `<button class="tab-btn ${i === activeTab ? 'active' : ''}" onclick="activeTab=${i};render();window.scrollTo({top:document.getElementById('tab-nav').offsetTop - 10, behavior:'smooth'});">${TAB_ICONS[i]} ${name}</button>`
  ).join('');
}

function render() {
  const summary = `${fmtK(S.estimatedSalePrice)} ¬∑ ${S.appreciationRate}% ¬∑ ${S.filingStatus === 'mfj' ? 'MFJ' : 'Single'} ¬∑ ${(S.incomeTaxBracket * 100).toFixed(0)}% bracket`;
  document.getElementById('settings-summary').textContent = summary;
  renderTabs();

  const sell = calcSell();
  const rental = calcRental();
  const eqProj = calcEquity(rental.annCF);
  const buying = calcBuying(sell.net);

  const tc = document.getElementById('tab-content');
  if (activeTab === 0) tc.innerHTML = renderOverview(sell);
  else if (activeTab === 1) tc.innerHTML = renderSell(sell);
  else if (activeTab === 2) tc.innerHTML = renderRent(rental, eqProj);
  else if (activeTab === 3) tc.innerHTML = renderBuying(buying, sell);
  else tc.innerHTML = renderVerdict(sell, rental, buying);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 1: OVERVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOverview() {
  const equity = S.estimatedSalePrice - PROPERTY.currentBalance;
  const totalMo = PROPERTY.monthlyPI + PROPERTY.monthlyHOA + PROPERTY.monthlyTaxes + PROPERTY.monthlyInsurance;
  const avgPSF = Math.round(COMPS.reduce((s, c) => s + c.price, 0) / COMPS.length / PROPERTY.sqft);
  const exclAmt = S.filingStatus === 'mfj' ? '$500K MFJ' : '$250K Single';

  return `<div class="stack">
    <div class="grid grid-2">
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
          <span style="font-size:18px;">üè†</span>
          <h3 style="font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Property Details</h3>
        </div>
        <div class="grid grid-2" style="gap:12px;">
          ${[['Bedrooms', PROPERTY.bedrooms], ['Bathrooms', PROPERTY.bathrooms], ['Square Feet', PROPERTY.sqft.toLocaleString()], ['Building', PROPERTY.building]].map(([l, v]) =>
            `<div><div class="stat-label">${l}</div><div style="font-size:18px;font-weight:800;font-family:var(--mono);">${v}</div></div>`
          ).join('')}
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:8px;"><span style="font-size:18px;">üè¶</span><h3 style="font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Mortgage Status</h3></div>
          <span class="badge badge-orange">üî• 2.5% RATE</span>
        </div>
        <div class="grid grid-2" style="gap:12px;">
          ${[['Original Loan', fmt(PROPERTY.originalLoan)], ['Current Balance', fmt(PROPERTY.currentBalance)], ['Monthly P&I', fmt(PROPERTY.monthlyPI)], ['Monthly HOA', fmt(PROPERTY.monthlyHOA)], ['Monthly Taxes', fmt(PROPERTY.monthlyTaxes)]].map(([l, v]) =>
            `<div><div class="stat-label">${l}</div><div style="font-size:18px;font-weight:800;font-family:var(--mono);">${v}</div></div>`
          ).join('')}
          <div style="grid-column:1/-1;border-top:2px solid #000;padding-top:12px;margin-top:4px;">
            <div class="stat-label">TOTAL MONTHLY</div>
            <div style="font-size:24px;font-weight:800;font-family:var(--mono);color:var(--primary);">${fmt(totalMo)}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
        <span style="font-size:18px;">üìä</span>
        <h3 style="font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Market Valuation</h3>
      </div>
      <div class="grid grid-3" style="margin-bottom:20px;">
        <div class="stat-center"><div class="stat-label">Purchase Price</div><div class="stat-value" style="color:#666;">${fmt(PROPERTY.purchasePrice)}</div><div class="stat-sub">${PROPERTY.purchaseDate}</div></div>
        <div class="stat-center"><div class="stat-label">Estimated Value</div><div class="stat-value" style="color:var(--primary);">${fmt(S.estimatedSalePrice)}</div><div class="stat-sub">Current Market</div></div>
        <div class="stat-center"><div class="stat-label">Current Equity</div><div class="stat-value" style="color:var(--accent);">${fmt(equity)}</div><div class="stat-sub">${fmt(equity)} available</div></div>
      </div>
      <h4 style="font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Comparable Sales</h4>
      <table>
        <thead><tr><th>Unit</th><th style="text-align:right;">Sale Price</th><th style="text-align:right;">Date</th></tr></thead>
        <tbody>${COMPS.map(c => `<tr><td style="font-weight:600;">${c.unit}</td><td style="text-align:right;font-weight:700;">${fmt(c.price)}</td><td style="text-align:right;color:var(--muted);">${c.date}</td></tr>`).join('')}</tbody>
      </table>
      <div style="text-align:right;margin-top:8px;font-size:12px;color:var(--muted);">Building Avg: <strong style="color:var(--primary);">~$${avgPSF}/sqft</strong></div>
    </div>

    <div class="alert-box green">
      <span style="font-size:24px;flex-shrink:0;">‚úì</span>
      <div>
        <div class="alert-title" style="color:var(--primary);">SECTION 121 CAPITAL GAINS EXCLUSION</div>
        <div class="alert-body">You have lived here ${S.yearsInResidence}+ years. You qualify for the full Section 121 capital gains exclusion (${exclAmt}). ${S.yearsInResidence >= 2 ? 'As of today, $0 in capital gains tax is owed on a sale.' : 'Note: You need at least 2 years of primary residence to qualify.'}</div>
      </div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 2: SELL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSell(sell) {
  const { cc, cg, net } = sell;
  const ccRows = [
    ['NYC Transfer Tax', `${(cc.nycRate * 100).toFixed(3)}%`, cc.nycTax],
    ['NYS Transfer Tax', '0.400%', cc.nysTax],
    ['Broker Commission', `${cc.brokerPct.toFixed(1)}%`, cc.broker],
    ['Attorney Fee', 'Flat', cc.attorney],
    ['Mortgage Satisfaction', 'Flat', cc.mortSat],
    ['Miscellaneous', '0.100%', cc.misc]
  ];
  const wfRows = [
    ['Gross Sale Price', S.estimatedSalePrice, false],
    ['NYC Transfer Tax', -cc.nycTax, true],
    ['NYS Transfer Tax', -cc.nysTax, true],
    ['Broker Commission', -cc.broker, true],
    ['Attorney / Misc / Fees', -(cc.attorney + cc.mortSat + cc.misc), true],
    ['Mortgage Payoff', -PROPERTY.currentBalance, true]
  ];

  const taxSection = cg.exempt
    ? `<div style="margin-top:16px;padding:16px;background:var(--primary-light);border:2px solid var(--primary);text-align:center;">
        <div style="font-size:24px;font-weight:900;color:var(--primary);">‚úì $0 CAPITAL GAINS TAX</div>
        <div style="font-size:13px;color:var(--primary);margin-top:4px;">Full Section 121 exclusion applies (${S.filingStatus === 'mfj' ? '$500K MFJ' : '$250K Single'})</div>
      </div>`
    : `<div style="margin-top:16px;"><table><tbody>
        ${[
          [`Federal CGT (${(cg.fedRate * 100).toFixed(0)}%)`, cg.fedTax],
          ['NYS CGT (6.85%)', cg.nysTaxCG],
          ['NYC CGT (3.876%)', cg.nycTaxCG]
        ].map(([l, v]) => `<tr><td style="font-weight:600;">${l}</td><td style="text-align:right;font-weight:700;color:var(--red);">${fmt(v)}</td></tr>`).join('')}
        <tr class="total-row"><td style="font-weight:900;">TOTAL TAX OWED</td><td style="text-align:right;font-weight:900;font-size:18px;color:var(--red);">${fmt(cg.totalTax)}</td></tr>
      </tbody></table></div>`;

  const barData = [
    { label: 'Sale Price', value: S.estimatedSalePrice, color: '#1C5355' },
    { label: 'Closing Costs', value: cc.total, color: '#D94F4F' },
    { label: 'Mortgage Payoff', value: PROPERTY.currentBalance, color: '#E8A838' },
    { label: 'Net Proceeds', value: net - cg.totalTax, color: '#4EB8BC' }
  ];

  return `<div class="stack">
    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üìã NYC / Brooklyn Seller Closing Costs</h3>
      <table><tbody>
        ${ccRows.map(([l, r, v]) => `<tr><td style="font-weight:600;">${l}</td><td style="text-align:center;color:var(--muted);">${r}</td><td style="text-align:right;font-weight:700;">${fmt(v)}</td></tr>`).join('')}
        <tr class="total-row"><td colspan="2" style="font-size:14px;">TOTAL CLOSING COSTS</td><td style="text-align:right;font-size:16px;color:var(--red);">${fmt(cc.total)}</td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üí∞ Net-to-Seller Waterfall</h3>
      <table><tbody>
        ${wfRows.map(([l, v, neg]) => `<tr><td style="font-weight:600;">${neg ? '‚àí  ' : ''}${l}</td><td style="text-align:right;font-weight:700;color:${neg ? 'var(--red)' : '#000'};">${fmt(Math.abs(v))}</td></tr>`).join('')}
        <tr class="total-row" style="background:var(--primary-light);"><td style="font-size:15px;color:var(--primary);">=  NET CASH TO SELLER</td><td style="text-align:right;font-size:20px;color:var(--primary);">${fmt(net)}</td></tr>
        ${cg.totalTax > 0 ? `<tr><td style="font-weight:600;color:var(--red);">‚àí  Capital Gains Tax</td><td style="text-align:right;font-weight:700;color:var(--red);">${fmt(cg.totalTax)}</td></tr>
        <tr class="total-row" style="background:var(--primary-light);"><td style="font-size:15px;color:var(--primary);">=  NET AFTER TAX</td><td style="text-align:right;font-size:20px;color:var(--primary);">${fmt(net - cg.totalTax)}</td></tr>` : ''}
      </tbody></table>
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üìä Capital Gains Tax Breakdown</h3>
      <table><tbody>
        ${[
          ['Adjusted Basis (Purchase + Improvements)', cg.adjBasis],
          ['Total Selling Costs', cg.sellingCosts],
          ['Gross Capital Gain', cg.grossGain],
          ['Section 121 Exclusion', -cg.excl],
          ['Taxable Gain', cg.taxable]
        ].map(([l, v]) => `<tr><td style="font-weight:600;">${l}</td><td style="text-align:right;font-weight:700;">${fmt(v)}</td></tr>`).join('')}
      </tbody></table>
      ${taxSection}
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Sale Proceeds Breakdown</h3>
      ${horizBarChart(barData)}
    </div>

    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin-bottom:12px;font-size:14px;font-weight:800;color:var(--primary);">‚úì Advantages</h3>
        ${['Immediate cash of ~' + fmtK(net), 'Unlock buying power for next home', 'Simplify finances ‚Äî no landlord headaches', 'CGT-free window while exclusion applies', 'Eliminate $4,649/mo carrying costs'].map(t => `<div class="pros-item">${t}</div>`).join('')}
      </div>
      <div class="card">
        <h3 style="margin-bottom:12px;font-size:14px;font-weight:800;color:var(--red);">‚úó Trade-offs</h3>
        ${['Lose irreplaceable 2.5% mortgage rate', 'Give up potential appreciation upside', 'Transaction costs ~7-8% round trip', 'Must time sale and purchase', 'Emotional cost of selling home'].map(t => `<div class="cons-item">${t}</div>`).join('')}
      </div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 3: RENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRent(ra, eqProj) {
  const expData = [
    { label: 'Mortgage', value: PROPERTY.monthlyPI, color: COLORS[0] },
    { label: 'HOA', value: PROPERTY.monthlyHOA, color: COLORS[1] },
    { label: 'Taxes', value: PROPERTY.monthlyTaxes, color: COLORS[2] },
    { label: 'Maintenance', value: Math.round(ra.maint), color: COLORS[3] }
  ];
  if (ra.mgmt > 0) expData.push({ label: 'Mgmt', value: Math.round(ra.mgmt), color: COLORS[4] });
  const last = eqProj[eqProj.length - 1] || { eq: 0, cumCF: 0, combined: 0 };

  return `<div class="stack">
    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üéõÔ∏è Rental Income Calculator</h3>
      <div class="grid grid-2" style="gap:0 24px;">
        <div class="slider-wrap"><div class="slider-head"><span class="label">Monthly Rent</span><span class="val">$${S.monthlyRent.toLocaleString()}</span></div><input type="range" id="in-rent" min="4000" max="7000" step="100" value="${S.monthlyRent}" oninput="onRentalChange()"></div>
        <div class="slider-wrap"><div class="slider-head"><span class="label">Vacancy Reserve</span><span class="val">${S.vacancyPercent}%</span></div><input type="range" id="in-vacancy" min="0" max="15" step="1" value="${S.vacancyPercent}" oninput="onRentalChange()"></div>
        <div class="slider-wrap"><div class="slider-head"><span class="label">Maintenance Reserve</span><span class="val">${S.maintenancePercent}%</span></div><input type="range" id="in-maint" min="5" max="20" step="1" value="${S.maintenancePercent}" oninput="onRentalChange()"></div>
        <div class="slider-wrap"><div class="slider-head"><span class="label">Property Management</span><span class="val">${S.propertyManagementPercent}%</span></div><input type="range" id="in-mgmt" min="0" max="12" step="1" value="${S.propertyManagementPercent}" oninput="onRentalChange()"></div>
      </div>
    </div>

    <div class="grid grid-3">
      <div class="card"><div class="stat-center"><div class="stat-label">Effective Income</div><div class="stat-value" style="color:var(--primary);">${fmt(ra.egi)}</div><div class="stat-sub">/month</div></div></div>
      <div class="card"><div class="stat-center"><div class="stat-label">Total Expenses</div><div class="stat-value" style="color:var(--red);">${fmt(ra.totalExp)}</div><div class="stat-sub">/month</div></div></div>
      <div class="card"><div class="stat-center"><div class="stat-label">Net Cash Flow</div><div class="stat-value" style="color:${ra.cf >= 0 ? 'var(--primary)' : 'var(--red)'};">${fmt(ra.cf)}</div><div class="stat-sub">/month</div></div></div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <h4 style="margin-bottom:12px;font-size:14px;font-weight:800;text-transform:uppercase;">Expense Breakdown</h4>
        ${donutChart(expData)}
      </div>
      <div class="card">
        <div class="grid grid-2">
          <div class="stat-center"><div class="stat-label">Annual Cash Flow</div><div class="stat-value" style="color:${ra.annCF >= 0 ? 'var(--primary)' : 'var(--red)'};">${fmt(ra.annCF)}</div><div class="stat-sub">/year</div></div>
          <div class="stat-center"><div class="stat-label">Return on Equity</div><div class="stat-value" style="color:var(--accent);">${ra.roe.toFixed(1)}%</div><div class="stat-sub">Annual ROE</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üìâ Depreciation Tax Benefit</h3>
      <div class="grid grid-3">
        <div class="stat-center"><div class="stat-label">Building Value (80%)</div><div class="stat-value">${fmt(ra.bldg)}</div></div>
        <div class="stat-center"><div class="stat-label">Annual Depreciation</div><div class="stat-value" style="color:var(--accent);">${fmt(ra.annDepr)}</div></div>
        <div class="stat-center"><div class="stat-label">Annual Tax Savings</div><div class="stat-value" style="color:var(--primary);">${fmt(ra.annSavings)}</div></div>
      </div>
    </div>

    <div class="alert-box red">
      <span style="font-size:24px;flex-shrink:0;">‚ö†Ô∏è</span>
      <div>
        <div class="alert-title" style="color:var(--red);">DEPRECIATION RECAPTURE WARNING</div>
        <div class="mono" style="font-size:13px;line-height:1.8;">
          Years Held as Rental: <strong>${S.yearsHeldAsRental}</strong><br>
          Total Depreciation Taken: <strong>${fmt(ra.totalDepr)}</strong><br>
          Recapture Tax (Section 1250 @ 25%): <strong style="color:var(--red);">${fmt(ra.recap)}</strong>
        </div>
        <div style="margin-top:8px;font-size:13px;line-height:1.5;">If you sell after renting, this amount is added back as ordinary income at 25%. This partially offsets the tax benefits received during the rental period.</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üìà ${S.yearsHeldAsRental}-Year Equity Projection</h3>
      ${areaChart(eqProj)}
      <div class="grid grid-3" style="margin-top:16px;border-top:2px solid #000;padding-top:16px;">
        <div class="stat-center"><div class="stat-label">Year ${S.yearsHeldAsRental} Equity</div><div class="stat-value">${fmt(last.eq)}</div></div>
        <div class="stat-center"><div class="stat-label">Total Cash Flow</div><div class="stat-value" style="color:var(--accent);">${fmt(last.cumCF)}</div></div>
        <div class="stat-center"><div class="stat-label">Combined Value</div><div class="stat-value" style="color:var(--primary);">${fmt(last.combined)}</div></div>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin-bottom:12px;font-size:14px;font-weight:800;color:var(--primary);">‚úì Advantages</h3>
        ${[`Keep irreplaceable 2.5% rate`, `${fmt(ra.annSavings)}/yr depreciation tax savings`, 'Build equity while tenant pays mortgage', 'Potential appreciation upside', 'Passive income stream'].map(t => `<div class="pros-item">${t}</div>`).join('')}
      </div>
      <div class="card">
        <h3 style="margin-bottom:12px;font-size:14px;font-weight:800;color:var(--red);">‚úó Trade-offs</h3>
        ${[`Cash flow may be negative (${fmt(ra.cf)}/mo)`, `${fmt(ra.recap)} depreciation recapture on sale`, 'Landlord headaches & liability', 'Lose Section 121 exclusion after 3yr away', 'Capital tied up in illiquid asset'].map(t => `<div class="cons-item">${t}</div>`).join('')}
      </div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 4: BUYING POWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBuying(bp, sell) {
  const { a, b } = bp;
  const delta = a.max - b.max;
  const renderCC = (cc, label) => `
    <h4 style="font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin:12px 0 8px;">${label} ‚Äî Buyer Closing Costs</h4>
    <table style="font-size:12px;"><tbody>
      ${[
        [`Mortgage Recording Tax (${(cc.mrtRate * 100).toFixed(2)}%)`, cc.mrt],
        [`Mansion Tax (${(cc.manRate * 100).toFixed(1)}%)`, cc.man],
        ['Title Insurance (0.5%)', cc.title],
        ['Attorney Fee', cc.att],
        ['Inspection / Misc', cc.insp]
      ].map(([l, v]) => `<tr><td style="padding:5px 6px;">${l}</td><td style="padding:5px 6px;text-align:right;font-weight:700;">${fmt(v)}</td></tr>`).join('')}
      <tr class="total-row"><td style="padding:7px 6px;">Total (${cc.effPct.toFixed(1)}%)</td><td style="padding:7px 6px;text-align:right;color:var(--red);">${fmt(cc.total)}</td></tr>
    </tbody></table>`;

  const renderPITI = (opt) => `
    <div style="margin-top:16px;padding:12px;background:#f5f5f0;border:1px solid #ddd;">
      <h5 style="margin-bottom:8px;font-size:12px;font-weight:800;text-transform:uppercase;">Monthly PITI on ${fmtK(S.newHomePurchasePrice)} Home</h5>
      <div class="mono" style="font-size:12px;display:flex;flex-direction:column;gap:4px;">
        <div style="display:flex;justify-content:space-between;"><span>P&I (${pctF(S.newMortgageRate)})</span><span>${fmt(opt.pi)}</span></div>
        <div style="display:flex;justify-content:space-between;"><span>Est. Taxes</span><span>${fmt(opt.tax)}</span></div>
        <div style="display:flex;justify-content:space-between;"><span>Est. Insurance</span><span>${fmt(opt.ins)}</span></div>
        <div style="display:flex;justify-content:space-between;border-top:2px solid #000;padding-top:4px;font-weight:900;"><span>TOTAL PITI</span><span style="color:var(--primary);">${fmt(opt.piti)}</span></div>
      </div>
    </div>`;

  return `<div class="stack">
    <div class="card">
      <h3 style="margin-bottom:4px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üéõÔ∏è New Mortgage Assumptions</h3>
      <p style="margin-bottom:12px;font-size:12px;color:var(--muted);">These sliders affect both scenarios below.</p>
      <div class="grid grid-2" style="gap:0 24px;">
        <div class="slider-wrap"><div class="slider-head"><span class="label">New Mortgage Rate</span><span class="val">${S.newMortgageRate}%</span></div><input type="range" id="in-newRate" min="5" max="8" step="0.125" value="${S.newMortgageRate}" oninput="onBuyingChange()"></div>
        <div class="slider-wrap"><div class="slider-head"><span class="label">Down Payment %</span><span class="val">${S.downPaymentPercent}%</span></div><input type="range" id="in-dpPct" min="10" max="30" step="1" value="${S.downPaymentPercent}" oninput="onBuyingChange()"></div>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
          <span class="badge badge-primary">Option A</span>
          <span style="font-weight:800;">Sell & Buy</span>
        </div>
        <div class="mono" style="font-size:13px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>Net Sale Proceeds</span><strong>${fmt(a.dp)}</strong></div>
          ${renderCC(a.cc, 'Option A')}
          <div style="display:flex;justify-content:space-between;border-top:2px solid #000;padding-top:8px;margin-top:8px;"><span style="font-weight:800;">Net Available for Down Payment</span><strong style="color:var(--primary);">${fmt(a.netDP)}</strong></div>
        </div>
        ${renderPITI(a)}
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
          <span class="badge badge-accent">Option B</span>
          <span style="font-weight:800;">Keep & Buy</span>
        </div>
        <div class="mono" style="font-size:13px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>TOD Account Available</span><strong>${fmt(b.dp)}</strong></div>
          ${renderCC(b.cc, 'Option B')}
          <div style="display:flex;justify-content:space-between;border-top:2px solid #000;padding-top:8px;margin-top:8px;"><span style="font-weight:800;">Net Available for Down Payment</span><strong style="color:var(--accent);">${fmt(b.netDP)}</strong></div>
        </div>
        ${renderPITI(b)}
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Max Buying Power Comparison</h3>
      ${horizBarChart([
        { label: 'Sell & Buy', value: Math.max(0, a.max), color: '#1C5355' },
        { label: 'Keep & Buy', value: Math.max(0, b.max), color: '#4EB8BC' }
      ])}
      ${delta > 0 ? `<div style="text-align:center;margin-top:16px;"><span class="badge badge-primary">+ ${fmtK(delta)} BUYING POWER BY SELLING</span></div>` : delta < 0 ? `<div style="text-align:center;margin-top:16px;"><span class="badge badge-accent">+ ${fmtK(Math.abs(delta))} BUYING POWER BY KEEPING (TOD)</span></div>` : ''}
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 5: VERDICT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderVerdict(sell, ra, bp) {
  const rows = [
    { factor: 'Immediate Cash', a: fmt(sell.net), b: '$0', w: 'A' },
    { factor: 'Monthly Cash Flow', a: '$0', b: fmt(ra.cf) + '/mo', w: ra.cf > 0 ? 'B' : 'A' },
    { factor: 'Buying Power', a: fmtK(bp.a.max), b: fmtK(bp.b.max), w: bp.a.max > bp.b.max ? 'A' : 'B' },
    { factor: 'Mortgage Rate', a: 'Lose 2.5%', b: 'Keep 2.5%', w: 'B' },
    { factor: 'Capital Gains Tax', a: fmt(sell.cg.totalTax), b: 'N/A', w: sell.cg.exempt ? 'A' : 'B' },
    { factor: 'Depreciation Benefit', a: '$0/yr', b: fmt(ra.annSavings) + '/yr', w: 'B' },
    { factor: 'Landlord Risk', a: 'None', b: 'High', w: 'A' },
    { factor: 'Tax Complexity', a: 'Simple', b: 'Complex', w: 'A' }
  ];
  const aW = rows.filter(r => r.w === 'A').length;
  const bW = rows.filter(r => r.w === 'B').length;
  const strongRent = ra.cf > 1000;

  return `<div class="stack">
    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">‚öñÔ∏è Side-by-Side Comparison</h3>
      <table>
        <thead><tr>
          <th>Factor</th>
          <th style="text-align:center;color:var(--primary);">Option A: Sell</th>
          <th style="text-align:center;color:var(--accent);">Option B: Keep</th>
          <th style="text-align:center;">Winner</th>
        </tr></thead>
        <tbody>${rows.map(r => `<tr>
          <td style="font-weight:700;">${r.factor}</td>
          <td class="mono" style="text-align:center;font-weight:600;${r.w === 'A' ? 'background:var(--primary-light);color:var(--primary);' : 'color:var(--muted);'}">${r.a}</td>
          <td class="mono" style="text-align:center;font-weight:600;${r.w === 'B' ? 'background:var(--accent-light);color:var(--primary);' : 'color:var(--muted);'}">${r.b}</td>
          <td style="text-align:center;"><span class="badge ${r.w === 'A' ? 'badge-primary' : 'badge-accent'}">${r.w === 'A' ? 'SELL' : 'KEEP'}</span></td>
        </tr>`).join('')}</tbody>
      </table>
      <div class="mono" style="display:flex;gap:16px;justify-content:center;margin-top:16px;font-size:14px;font-weight:700;">
        <span style="color:var(--primary);">Sell: ${aW}</span> | <span style="color:var(--accent);">Keep: ${bW}</span>
      </div>
    </div>

    <div class="callout-big">
      <div class="label">RECOMMENDATION</div>
      <div class="headline">${strongRent ? 'SELL IF BUYING, CONSIDER KEEPING IF NOT MOVING' : 'SELL THE PROPERTY'}</div>
      <div class="body">${strongRent
        ? `With ${fmt(ra.cf)}/mo positive cash flow, keeping the property is viable if you're not purchasing a new home. However, if you need buying power for a new home, selling unlocks ${fmtK(sell.net)} in tax-free proceeds.`
        : `At ${fmt(ra.cf)}/mo cash flow and the Section 121 exclusion window open, selling generates ${fmtK(sell.net)} in tax-free proceeds. The 2.5% rate is valuable, but the negative/low cash flow and landlord complexity don't justify holding.`
      }</div>
    </div>

    <div class="card">
      <button class="collapsible-btn" onclick="document.getElementById('keep-reasons').classList.toggle('hidden'); this.querySelector('.chevron').textContent = document.getElementById('keep-reasons').classList.contains('hidden') ? '‚ñº' : '‚ñ≤';">
        <span>When Keeping Might Make Sense</span>
        <span class="chevron">‚ñº</span>
      </button>
      <div id="keep-reasons" class="hidden" style="margin-top:16px;display:flex;flex-direction:column;gap:8px;">
        ${['You are NOT planning to buy another home', 'Rent increases significantly (>$6,500/mo)', 'You want to hold for 10+ years for appreciation', 'You move out temporarily and plan to return'].map(t =>
          `<div style="font-size:13px;display:flex;gap:8px;align-items:center;"><span style="color:var(--accent);">‚Üí</span> ${t}</div>`
        ).join('')}
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">üìù Next Steps</h3>
      ${['Consult tax attorney to confirm Section 121 eligibility', 'Get broker CMA to confirm $575K value', 'If selling: list by spring for peak Brooklyn market', 'If keeping: get lease drafted, hire property manager'].map((t, i) =>
        `<div class="step-row"><div class="step-num">${i + 1}</div><span style="font-size:14px;padding-top:4px;">${t}</span></div>`
      ).join('')}
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
syncInputsToState();

// Hash-based routing: #analysis opens analysis page directly
function routeFromHash() {
  if (window.location.hash === '#analysis') {
    document.getElementById('app-landing').classList.add('hidden');
    document.getElementById('app-analysis').classList.remove('hidden');
    render();
  } else {
    document.getElementById('app-landing').classList.remove('hidden');
    document.getElementById('app-analysis').classList.add('hidden');
  }
}
window.addEventListener('hashchange', routeFromHash);
routeFromHash();

// Keyboard shortcut: Escape to close settings
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    const b = document.getElementById('settings-body');
    if (!b.classList.contains('hidden')) toggleSettings();
  }
});
</script>
</body>
</html>
